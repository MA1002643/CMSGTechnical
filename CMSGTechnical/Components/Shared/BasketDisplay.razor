@using CMSGTechnical.Code
@using CMSGTechnical.Mediator.Dtos

<div class="basket">
    <h4 class="basket__title">
        Your Basket
        @if (LastUpdated != default)
        {
            <span class="basket__updated" title="Last updated">✓</span>
        }
    </h4>

    @if (!GroupedItems.Any())
    {
        <p class="basket__empty">Your basket is empty.</p>
    }
    else
    {
        @foreach (var entry in GroupedItems)
        {
            <div class="basket-line">
                <div class="basket-line__info">
                    <div class="basket-line__name">@entry.Item.Name</div>
                    <div class="basket-line__meta">@entry.Item.Category • £@entry.Item.Price.ToString("0.00") each</div>
                </div>
                <div class="basket-line__controls">
                    <button class="btn btn-light btn-round" @onclick="() => Add(entry.Item)" title="Add item">+</button>
                    <span class="basket-line__qty">@entry.Quantity</span>
                    <button class="btn btn-light btn-round" @onclick="() => Remove(entry.Item)" title="Remove item">-</button>
                    <span class="basket-line__total">£@entry.LineTotal.ToString("0.00")</span>
                </div>
            </div>
        }
    }

    <div class="basket-totals">
        <div class="basket-totals__row">
            <span>Subtotal</span>
            <strong>£@BasketService.Subtotal.ToString("0.00")</strong>
        </div>
        <div class="basket-totals__row">
            <span>Delivery fee</span>
            <strong>£@BasketService.Delivery.ToString("0.00")</strong>
        </div>
        <div class="basket-totals__row basket-totals__total">
            <span>Total</span>
            <strong>£@BasketService.Total.ToString("0.00")</strong>
        </div>
    </div>
</div>


@code {
    [CascadingParameter]
    private BasketService BasketService { get; set; }

    private DateTime LastUpdated { get; set; }

    private IEnumerable<BasketLine> GroupedItems => BasketService.Basket.MenuItems
        .GroupBy(i => i.Id)
        .Select(g => new BasketLine(g.Key, g.First(), g.Count(), g.Sum(i => i.Price)));

    protected override void OnInitialized()
    {
        BasketService.OnChange += (_, _) => 
        {
            LastUpdated = DateTime.UtcNow;
            InvokeAsync(StateHasChanged);
        };
    }

    private Task Add(MenuItemDto item) => BasketService.Add(item);

    private Task Remove(MenuItemDto item) => BasketService.Remove(item);

    private record BasketLine(int Id, MenuItemDto Item, int Quantity, decimal LineTotal);
}
